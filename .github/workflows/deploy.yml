name: Deploy to Uberspace

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy to Uberspace via SSH with Memory Logging and Build-Repetition
        uses: appleboy/ssh-action@master
        with:
          host: horologium.uberspace.de
          username: kasunshi
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            # Wir nutzen hier "set -e" nicht strikt, damit wir Fehler manuell behandeln können.
            echo ">>> Adding ~/bin to PATH..."
            export PATH=$PATH:~/bin

            # Arbeitsverzeichnisse
            PROD_DIR=~/html/sunshine-cbd
            TEMP_DIR=~/html/sunshine-cbd_temp

            # Funktion zur Ausgabe von Memory-Status (unter Linux)
            function log_memory() {
              echo ">>> Memory usage (free -m):"
              free -m
              echo ">>> Top processes (top -b -n 1 | head -20):"
              top -b -n 1 | head -20
            }

            log_memory

            echo ">>> Stopping current production (PM2)..."
            pm2 stop all || true
            pm2 delete all || true

            log_memory

            echo ">>> Creating temporary directory..."
            rm -rf $TEMP_DIR
            mkdir -p $TEMP_DIR

            echo ">>> Syncing current production state to TEMP_DIR..."
            rsync -a --delete $PROD_DIR/ $TEMP_DIR/

            echo ">>> Updating code in TEMP_DIR..."
            cd $TEMP_DIR
            git pull origin dev

            echo ">>> Installing dependencies in TEMP_DIR..."
            npm install

            log_memory

            echo ">>> Running tests in TEMP_DIR with memory limit..."
            # Setze das Memory-Limit für alle Node-Prozesse
            export NODE_OPTIONS="--max-old-space-size=512"
            # Führe die Tests aus (hier sollten deine Test-Skripte in package.json definiert sein, z.B. "ci:all")
            npm run ci:all || TEST_FAILED=true

            log_memory

            echo ">>> Clearing Next.js cache before build..."
            rm -rf .next

            echo ">>> Building the project in TEMP_DIR with retry on failure..."
            ATTEMPTS=0
            # Wiederhole den Build solange, bis er erfolgreich ist.
            while true; do
              export NODE_ENV=production
              # Hier werden einige Parameter gesetzt, um den Cache zu deaktivieren und den Speicherverbrauch zu reduzieren.
              NODE_OPTIONS="--max-old-space-size=512" TURBO_FORCE=1 NEXT_DISABLE_CACHE=1 npm run build --no-lint --no-check
              if [ $? -eq 0 ]; then
                echo "✅ Build successful in TEMP_DIR!"
                break
              fi
              ATTEMPTS=$((ATTEMPTS+1))
              echo "❌ Build failed (attempt ${ATTEMPTS}), retrying in 5 seconds..."
              sleep 5
            done

            log_memory

            if [ "$TEST_FAILED" = "true" ]; then
              echo "❌ Tests failed! Rolling back production..."
              rm -rf $TEMP_DIR
              cd $PROD_DIR
              pm2 start "npm start" --name sunshine-cbd
              exit 1
            fi

            echo ">>> Deployment successful! Swapping TEMP_DIR to production..."
            rm -rf $PROD_DIR
            mv $TEMP_DIR $PROD_DIR

            log_memory

            echo ">>> Restarting PM2 process in production..."
            cd $PROD_DIR
            pm2 start "npm start" --name sunshine-cbd

            log_memory

            echo ">>> Deployment complete!"
