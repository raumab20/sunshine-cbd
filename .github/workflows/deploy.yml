name: Test and Deploy to Uberspace

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy to Uberspace via SSH
        uses: appleboy/ssh-action@master
        with:
          host: horologium.uberspace.de
          username: kasunshi
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            echo ">>> Adding ~/bin to PATH..."
            export PATH=$PATH:~/bin

            PROD_DIR=~/html/sunshine-cbd
            TEMP_DIR=~/html/sunshine-cbd_temp
            BACKUP_DIR=~/html/sunshine-cbd_backup

            echo ">>> Stoppe die aktuell laufende Produktion (PM2)..."
            pm2 stop all || true
            pm2 delete all || true

            echo ">>> Erstelle temporÃ¤res Verzeichnis..."
            rm -rf $TEMP_DIR
            mkdir -p $TEMP_DIR

            echo ">>> Synchronisiere aktuellen Produktionsstand in TEMP_DIR..."
            rsync -a --delete $PROD_DIR/ $TEMP_DIR/

            echo ">>> Aktualisiere Code in TEMP_DIR (git pull)..."
            cd $TEMP_DIR
            git pull origin dev

            echo ">>> Installing dependencies in TEMP_DIR..."
            npm install

            echo ">>> Running tests in TEMP_DIR with memory limit..."
            TEST_EXIT=0
            if ! NODE_OPTIONS="--max-old-space-size=1024" npm run ci:all; then
              TEST_EXIT=1
              echo ">>> Tests failed in TEMP_DIR!"
            else
              echo ">>> Tests passed in TEMP_DIR."
            fi

            if [ $TEST_EXIT -ne 0 ]; then
              echo ">>> Cleaning up TEMP_DIR and restarting production with existing version..."
              cd $PROD_DIR
              pm2 start "npm start" --name sunshine-cbd
              rm -rf $TEMP_DIR
              exit 1
            fi

            echo ">>> Building the project in TEMP_DIR with memory limit..."
            BUILD_SUCCESS=1
            while [ $BUILD_SUCCESS -ne 0 ]; do
              echo ">>> Clearing Next.js cache..."
              rm -rf .next
              NODE_OPTIONS="--max-old-space-size=1024" NEXT_DISABLE_CACHE=1 npm run build --verbose
              BUILD_SUCCESS=$?
              if [ $BUILD_SUCCESS -ne 0 ]; then
                echo "Build failed in TEMP_DIR, retrying in 5 seconds..."
                sleep 5
              fi
            done

            echo ">>> Creating backup of current production..."
            rm -rf $BACKUP_DIR
            cp -R $PROD_DIR $BACKUP_DIR

            echo ">>> Deploying new version from TEMP_DIR to PROD_DIR..."
            rsync -av --delete $TEMP_DIR/ $PROD_DIR/

            echo ">>> Installing dependencies in PROD_DIR..."
            cd $PROD_DIR
            npm install

            echo ">>> Building production version in PROD_DIR with memory limit..."
            BUILD_SUCCESS=1
            while [ $BUILD_SUCCESS -ne 0 ]; do
              echo ">>> Clearing Next.js cache..."
              rm -rf .next
              NODE_OPTIONS="--max-old-space-size=1024" NEXT_DISABLE_CACHE=1 npm run build --verbose
              BUILD_SUCCESS=$?
              if [ $BUILD_SUCCESS -ne 0 ]; then
                echo "Production build failed, retrying in 5 seconds..."
                sleep 5
              fi
            done

            echo ">>> Restarting PM2 process..."
            pm2 start "npm start" --name sunshine-cbd

            echo ">>> Cleaning up: Deleting TEMP_DIR..."
            rm -rf $TEMP_DIR

            echo ">>> Deployment complete!"
