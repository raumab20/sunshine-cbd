name: Deploy to Uberspace

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy to Uberspace via SSH
        uses: appleboy/ssh-action@master
        with:
          host: horologium.uberspace.de
          username: kasunshi
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            #!/bin/bash
            set -e

            echo ">>> Adding ~/bin to PATH..."
            export PATH=$PATH:~/bin

            # Setze ggf. ein globales Memory-Limit (hier 512 MB, wie in deiner letzten funktionierenden Version)
            export NODE_OPTIONS="--max-old-space-size=512"

            # Arbeitsverzeichnisse
            PROD_DIR=~/html/sunshine-cbd
            TEMP_DIR=~/html/sunshine-cbd_temp

            echo ">>> Wechsel in Produktionsverzeichnis..."
            cd $PROD_DIR
            echo ">>> Current directory:"
            pwd

            echo ">>> Pulling latest code in production..."
            git pull origin dev

            echo ">>> Stopping the application..."
            pm2 stop all
            pm2 delete all

            echo ">>> Creating temporary directory..."
            rm -rf $TEMP_DIR
            mkdir -p $TEMP_DIR

            echo ">>> Syncing current production state to TEMP_DIR..."
            rsync -a --delete $PROD_DIR/ $TEMP_DIR/

            echo ">>> Updating code in TEMP_DIR..."
            cd $TEMP_DIR
            git pull origin dev

            echo ">>> Installing dependencies in TEMP_DIR..."
            npm install

            # Optional: Falls du Tests ausführen möchtest, füge folgenden Block ein:
            echo ">>> Running tests in TEMP_DIR..."
            if ! npm run ci:all; then
              echo ">>> Tests failed in TEMP_DIR! Aborting deployment and restarting production..."
              cd $PROD_DIR
              pm2 start "npm start" --name sunshine-cbd
              rm -rf $TEMP_DIR
              exit 1
            fi

            echo ">>> Building the project..."
            # Wiederhole den Build-Prozess, falls er fehlschlägt.
            until NODE_OPTIONS="--max-old-space-size=512" npm run build --verbose; do
              echo "Build failed, retrying in 5 seconds..."
              sleep 5
            done

            echo ">>> Restarting PM2 process..."
            pm2 start "npm start" --name sunshine-cbd

            echo ">>> Deployment complete!"
