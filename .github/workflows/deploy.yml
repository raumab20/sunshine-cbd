name: Deploy to Uberspace

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Deploy to Uberspace via SSH
        uses: appleboy/ssh-action@master
        with:
          host: horologium.uberspace.de
          username: kasunshi
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo ">>> Adding ~/bin to PATH..."
            export PATH=$PATH:~/bin
            cd ~/html/sunshine-cbd
            echo ">>> Changed to directory:"
            pwd

            echo ">>> Reset local changes..."
            git reset --hard HEAD
            git clean -fd

            echo ">>> Pulling latest code..."
            git pull origin dev

            echo ">>> Stopping PM2 processes..."
            pm2 stop all || true
            pm2 delete all || true

            echo ">>> Installing dependencies..."
            npm install

            echo ">>> Checking .env.local file..."
            if [ ! -f ".env.local" ]; then
              echo "âš ï¸ .env.local not found! Copying from .env.example..."
              cp .env.example .env.local
            fi

            echo ">>> Running CI Pipeline..."
            if npm run ci:all; then
              echo "âœ… CI Pipeline successful. Proceeding to production deployment..."
              
              echo ">>> Building the project..."
              until NODE_OPTIONS="--max-old-space-size=512" npm run build --verbose; do
                echo "Build failed, retrying in 5 seconds..."
                sleep 5
              done

              echo ">>> Starting production..."
              pm2 start "npm start" --name sunshine-cbd
              echo "ğŸš€ Deployment complete!"
            else
              echo "âŒ CI Pipeline failed. Restarting old production..."
              pm2 start "npm start" --name sunshine-cbd
              echo "â™»ï¸ Old production restarted."
            fi
